# ThingsPanel Docker é•œåƒæ¨é€åˆ°é˜¿é‡Œäº‘ (ä¼ä¸šç‰ˆ)
#
# åŠŸèƒ½è¯´æ˜:
# 1. æ„å»º Docker é•œåƒ
# 2. æ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
#
# è§¦å‘æ–¹å¼:
# - Releaseè§¦å‘: å½“åˆ›å»ºæˆ–æ›´æ–° Release æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆä»»æ„åˆ†æ”¯ï¼‰
# - æ‰‹åŠ¨è§¦å‘: åªå…è®¸åœ¨ 2.1.0.RELEASE åˆ†æ”¯æ‰§è¡Œï¼Œéœ€è¦æ‰‹åŠ¨è¾“å…¥ç‰ˆæœ¬å·
#
# ç‰ˆæœ¬å·å¤„ç†:
# - Release è§¦å‘: ä½¿ç”¨ Release çš„ tag ä½œä¸ºç‰ˆæœ¬å·
# - æ‰‹åŠ¨è§¦å‘: ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ç‰ˆæœ¬å·
# - ä¸å…è®¸æ„å»º latest æ ‡ç­¾ï¼Œæ‰€æœ‰é•œåƒéƒ½å¿…é¡»æœ‰æ˜ç¡®çš„ç‰ˆæœ¬å·
#
# åˆ†æ”¯é™åˆ¶:
# - æ‰‹åŠ¨è§¦å‘ä»…å…è®¸åœ¨ 2.1.0.RELEASE åˆ†æ”¯æ‰§è¡Œ
# - Release è§¦å‘ä¸å—åˆ†æ”¯é™åˆ¶
#
# å¿…éœ€çš„ Secrets:
# - IMAGE_USER: é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ç”¨æˆ·å
# - IMAGE_PASS: é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡å¯†ç 

name: Docker Image Build

on:
  # æ‰‹åŠ¨è§¦å‘ï¼Œåªå…è®¸åœ¨ 2.1.0.RELEASE åˆ†æ”¯æ‰§è¡Œ
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v2.1.0)'
        required: true
        type: string

  # å‘å¸ƒ Release æ—¶ï¼ˆä»»æ„åˆ†æ”¯ï¼‰ä¾æ—§è§¦å‘
  release:
    types: [ published ]



jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: éªŒè¯åˆ†æ”¯é™åˆ¶
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.ref_name }}" != "2.1.0.RELEASE" ]; then
            echo "âŒ é”™è¯¯: æ‰‹åŠ¨è§¦å‘åªå…è®¸åœ¨ 2.1.0.RELEASE åˆ†æ”¯æ‰§è¡Œ"
            echo "å½“å‰åˆ†æ”¯: ${{ github.ref_name }}"
            echo "å…è®¸çš„åˆ†æ”¯: 2.1.0.RELEASE"
            exit 1
          fi
          echo "âœ… åˆ†æ”¯éªŒè¯é€šè¿‡: ${{ github.ref_name }}"

      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          # å¦‚æœæ˜¯releaseè§¦å‘ï¼Œä½¿ç”¨release tag
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥çš„ç‰ˆæœ¬å·
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ğŸ·ï¸ ä½¿ç”¨ç‰ˆæœ¬å·: $VERSION"

      - name: è®¾ç½® JDK 1.8
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: ä½¿ç”¨ Maven æ‰“åŒ…åç«¯ Jar
        run: |
          cd DataRoom
          mvn clean package -Dmaven.test.skip=true -P package

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
        uses: docker/login-action@v2
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.IMAGE_USER }}
          password: ${{ secrets.IMAGE_PASS }}

      - name: æ„å»ºå¹¶æ¨é€åˆ°é˜¿é‡Œäº‘
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            registry.cn-hangzhou.aliyuncs.com/thingspanel/dataroom-server:${{ env.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max