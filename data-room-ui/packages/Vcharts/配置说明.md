### VChart 自定义组件开发说明

### 一、开发步骤

#### 1. 确定图表类型和分类

明确你想要创建的 VChart 图表类型（如 `bar`, `line`, `pie` 等）和它所属的分类（如 `柱状图类`, `折线图类` 等，用于组织）。

#### 2. 创建配置文件

在 `packages/Vcharts/图表/<分类名>` 文件夹下创建一个新的 `.js` 文件，文件名使用你为组件取的**中文名**，例如 `V高级折线图.js`。

#### 3. 编写配置

在该 `.js` 文件中编写配置。你可以参考下面的【配置说明】章节，并结合 VChart 的官方文档 (<https://visactor.io/vchart/option/>) 来定义图表的默认 `option` (spec) 和 `setting` (右侧配置面板)。

#### 4. 添加预览图

在 `packages/Vcharts/images/` 目录下添加一张 `.png` 格式的预览图，图片文件名应与步骤 2 中创建的 `.js` 文件名（即组件的中文名）**完全一致**，例如 `V高级折线图.png`。

#### 5. 配置组件顺序

编辑 `packages/Vcharts/vchartListSort.js` 文件，将你的组件中文名添加到 `export default` 的数组中。数组元素的顺序决定了组件在左侧组件列表中的显示顺序。

```javascript
// packages/Vcharts/vchartListSort.js
export default [
  'V基础柱状图',
  'V基础折线图',
  'V高级折线图', // <-- 添加你的组件名
  // ... 其他组件
]
```

### 二、配置说明

以下是一个 VChart 组件 (`V基础柱状图.js`) 配置文件的示例和说明：

```javascript
// 配置版本号 (可选，用于标识配置变更)
const version = '2024051501'
// 标题 (显示在组件列表和添加到画布上的默认标题)
const title = 'V基础柱状图'
// 用于标识，唯一，建议与文件名、title 保持一致
const name = 'V基础柱状图'
// 组件类型标识 (固定为 'customComponent'，表示使用自定义渲染逻辑)
const type = 'customComponent'
// VChart 图表类型标识 (核心，如 'bar', 'line', 'pie', 'area' 等，对应 VChart spec 的 type)
const chartType = 'bar'

// 右侧配置项 (定义在编辑器右侧面板显示的配置控件)
const setting = [
  // --- 数据配置项 (通常 tabName 为 'data') ---
  {
    label: '维度(X轴)',         // 显示在配置面板上的标签文字
    type: 'select',           // 配置控件的类型 (select, inputNumber, colorPicker, switch, radio, textarea 等)
    field: 'xField',          // 组件内部使用的字段标识 (通常与 optionField 或逻辑相关)
    optionField: 'xField',    // **核心**: 映射到 VChart spec 中的哪个字段路径。使用点(.)分隔嵌套路径。
    multiple: false,          // 是否允许多选 (仅对 type: 'select' 有效)
    value: '',                // 该配置项的默认值
    tabName: 'data'           // 配置项所属的 Tab 页 ('data' 或 'custom')
  },
  {
    label: '指标(Y轴)',
    type: 'select',
    field: 'yField',
    optionField: 'yField',
    multiple: false,
    value: '',
    tabName: 'data'
  },
  // --- 图表样式配置项 (通常 tabName 为 'custom') ---
  {
    label: '柱子宽度',
    type: 'inputNumber',      // 数字输入框
    field: 'barWidth',        // 内部字段标识
    optionField: 'series.0.barWidth', // 映射到 VChart spec 的第一个系列的 barWidth
    value: 20,                // 默认宽度 20
    tabName: 'custom',        // 属于自定义样式 Tab
    groupName: 'graph'        // **VChart 特有**: 用于在自定义 Tab 内部分组显示 (如 'graph', 'axis', 'legend', 'tooltip')
  },
  {
    label: '主题选择',          // 固定配置，用于选择 VChart 主题
    type: 'select',           // 下拉选择
    field: 'chartTheme',      // 固定字段名
    optionField: 'theme',     // 映射到 VChart spec 的顶层 theme 字段
    options: [],              // 选项由 VchartCustomSetting 组件动态生成，这里可为空或省略
    value: 'light',           // 默认主题
    tabName: 'custom',
    groupName: 'graph'        // 属于图表核心分组
   },
   {
    label: 'Option 覆盖 (JSON)', // 固定配置，用于高级用户直接覆盖 spec
    type: 'textarea',         // 文本域
    field: 'optionOverride',  // 固定字段名
    optionField: '',          // 此字段不直接映射，由 VchartRender 特殊处理
    value: '{}',              // 默认空 JSON 对象字符串
    tabName: 'custom',
    groupName: 'graph'
   }
  // ... 可以添加更多轴、图例、提示等配置项 ...
]

// 示例数据 (定义图表在添加到画布时的初始/默认数据结构)
const data = {
  id: 'barData',  // 数据集的 ID，用于在 spec 中引用
  values: [       // 包含实际数据的数组
    { category: '类别1', value: 34 },
    { category: '类别2', value: 18 },
    { category: '类别3', value: 23 },
    { category: '类别4', value: 47 },
    { category: '类别5', value: 32 }
  ]
};

// 默认 VChart Option (即 VChart 的 Spec 配置)
// 这是图表添加到画布时的基础 Spec 结构
// 参考 VChart 官方文档: https://visactor.io/vchart/option/
const option = {
  type: 'bar',                // 图表类型，应与顶层的 chartType 一致
  data: [data],               // **核心**: 引用上面定义的 data 对象。注意是数组形式。
                              // 运行时，此处的 values 会被接口数据或 dataHandler 处理后的数据替换。
  xField: 'category',         // 默认的 X 轴字段名
  yField: 'value',            // 默认的 Y 轴字段名
  axes: [                     // 坐标轴配置 (数组)
    {
      orient: 'bottom',       // 底部 X 轴
      type: 'band',           // 类目轴
      visible: true           // 默认可见
    },
    {
      orient: 'left',         // 左侧 Y 轴
      type: 'linear',         // 线性轴
      visible: true,          // 默认可见
      grid: { visible: true } // 显示网格线
    }
  ],
  theme: 'light',             // 默认应用的 VChart 主题名称
  series: [                   // 系列配置 (数组)
    {
      type: 'bar',            // 系列类型，应与顶层 type 一致
      barWidth: 20            // 系列相关的默认样式，应与 setting 中的默认值匹配
      // ... 其他系列配置 ...
    }
  ],
  tooltip: {                  // 提示信息配置
    visible: true             // 默认启用 tooltip
  }
  // ... 其他 VChart spec 配置，如图例(legends), 标题(title), 动画(animation)等 ...
}

// 用于在运行时通过脚本修改 *最终 spec* 的函数体字符串 (高级功能)
// 可用变量: option (即将传递给 VChart 的 spec 对象), setting (右侧配置项数组), data (接口返回或 dataHandler 处理后的数据)
// 注意：直接修改 option 对象。谨慎使用。
const optionHandler = `
  // 示例：如果数据量大于 10，强制隐藏图例
  // if(data && data.length > 10 && option.legends) {
  //   option.legends.forEach(legend => legend.visible = false);
  // }
`;

// 用于在运行时通过脚本处理 *接口返回数据* 的函数体字符串
// 可用变量: data (接口原始数据), option (当前 VChart spec 对象), setting (右侧配置项数组)
// **重要**: 此函数需要返回处理后的数据数组。
const dataHandler = `
  // 示例：将接口返回数据中的 value 乘以 100
  // return data.map(item => ({ ...item, value: item.value * 100 }));

  // 如果不需要处理，保持为空字符串或返回原始 data
  return data;
`;

// 导出最终配置对象
export default {
  version,
  title,
  name,
  type,       // 'customComponent'
  chartType,  // 'bar', 'line' etc.
  option,     // 默认 VChart Spec
  setting,    // 右侧面板配置
  optionHandler, // Option 处理脚本
  dataHandler   // Data 处理脚本
}
```

**关键点总结 (VChart 与 G2Plot 的主要不同):**

1.  **核心配置对象:** VChart 使用的是 **Spec (Specification)** 对象，虽然在我们的配置文件里字段名叫 `option`，但它遵循 VChart 的 Spec 结构。
2.  **数据绑定:**
    *   配置文件中的 `data` 对象定义了**初始/默认**数据结构，包含 `id` 和 `values`。
    *   配置文件中的 `option.data` 字段引用了这个 `data` 对象 (`[data]`)。
    *   运行时的实际数据通常通过接口获取，并在 `VchartRender` 的 `dataFormatting` 中处理，最终会替换掉 `spec.data[0].values`。
    *   `setting` 中 `tabName: 'data'` 的配置项（如 `xField`, `yField`）用于让用户选择数据集中哪些列绑定到 VChart spec 的 `xField`, `yField` 等。
3.  **`setting` 中的 `optionField`:** 使用点(`.`)访问 VChart Spec 的层级结构，例如 `series.0.barWidth` 指向第一个系列的 `barWidth` 属性。
4.  **`setting` 中的 `groupName`:** 用于在编辑器右侧面板对自定义配置项进行分组，提升用户体验。
5.  **`chartType` vs `type`:**
    *   顶层的 `type` 固定为 `'customComponent'`。
    *   顶层的 `chartType` 对应 VChart 的图表类型 (如 `'bar'`)，也会体现在 `option.type` 和 `option.series[0].type` 中。
6.  **`optionHandler` 和 `dataHandler`:** 使用 `new Function` 执行，需要注意安全性和作用域。`dataHandler` 应返回处理后的数据数组。

希望这个 VChart 版本的配置说明能帮助你更好地理解和开发 VChart 自定义组件！